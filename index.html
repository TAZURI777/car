<script>
document.addEventListener('DOMContentLoaded', () => {
    // âœ… ì „êµ­ LGì „ì ì„¼í„° ì¢Œí‘œ ë°ì´í„° (ì´ì „ê³¼ ë™ì¼)
    const serviceCenters = [
        { name: "ê°•ë‚¨ì„¼í„°", lat: 37.4947, lon: 127.0305 },{ name: "ê°•ë™ì„¼í„°", lat: 37.5485, lon: 127.1471 },{ name: "ê°•ë¶ì„¼í„°", lat: 37.6328, lon: 127.0253 },{ name: "ê°•ì„œì„¼í„°", lat: 37.5601, lon: 126.8488 },{ name: "ê´€ì•…ì„¼í„°", lat: 37.4789, lon: 126.9503 },{ name: "ê´‘ì§„ì„¼í„°", lat: 37.5385, lon: 127.0827 },{ name: "êµ¬ë¡œì„¼í„°", lat: 37.4954, lon: 126.8872 },{ name: "ê¸ˆì²œì„¼í„°", lat: 37.4526, lon: 126.9038 },{ name: "ë…¸ì›ì„¼í„°", lat: 37.6548, lon: 127.0594 },{ name: "ë™ëŒ€ë¬¸ì„¼í„°", lat: 37.5742, lon: 127.0396 },{ name: "ë™ì‘ì„¼í„°", lat: 37.5080, lon: 126.9427 },{ name: "ë§ˆí¬ì„¼í„°", lat: 37.5634, lon: 126.9084 },{ name: "ì„œëŒ€ë¬¸ì„¼í„°", lat: 37.5794, lon: 126.9366 },{ name: "ì„œì´ˆì„¼í„°", lat: 37.4836, lon: 127.0174 },{ name: "ì„±ë™ì„¼í„°", lat: 37.5634, lon: 127.0252 },{ name: "ì„±ë¶ì„¼í„°", lat: 37.5891, lon: 127.0182 },{ name: "ì†¡íŒŒì„¼í„°", lat: 37.5144, lon: 127.1058 },{ name: "ì–‘ì²œì„¼í„°", lat: 37.5173, lon: 126.8664 },{ name: "ì˜ë“±í¬ì„¼í„°", lat: 37.5262, lon: 126.8966 },{ name: "ìš©ì‚°ì„¼í„°", lat: 37.5323, lon: 126.9644 },{ name: "ì€í‰ì„¼í„°", lat: 37.6027, lon: 126.9189 },{ name: "ì¤‘ë‘ì„¼í„°", lat: 37.6062, lon: 127.0940 },
        { name: "ê²½ê¸°ê´‘ì£¼ì„¼í„°", lat: 37.4087, lon: 127.2519 },{ name: "ê´‘ëª…ì„¼í„°", lat: 37.4789, lon: 126.8647 },{ name: "êµ¬ë¦¬ì„¼í„°", lat: 37.5991, lon: 127.1430 },{ name: "êµ°í¬ì„¼í„°", lat: 37.3618, lon: 126.9351 },{ name: "ê¹€í¬ì„¼í„°", lat: 37.6152, lon: 126.7157 },{ name: "ë‚¨ì–‘ì£¼ì„¼í„°", lat: 37.6341, lon: 127.2158 },{ name: "ë¶€ì²œì„¼í„°", lat: 37.4839, lon: 126.7831 },{ name: "ë¶„ë‹¹ì„¼í„°", lat: 37.3862, lon: 127.1215 },{ name: "ìˆ˜ì›ì„¼í„°", lat: 37.2636, lon: 127.0286 },{ name: "ì‹œí¥ì„¼í„°", lat: 37.3800, lon: 126.8028 },{ name: "ì•ˆì‚°ì„¼í„°", lat: 37.3216, lon: 126.8309 },{ name: "ì•ˆì„±ì„¼í„°", lat: 37.0084, lon: 127.2721 },{ name: "ì•ˆì–‘ì„¼í„°", lat: 37.3911, lon: 126.9515 },{ name: "ì˜¤ì‚°ì„¼í„°", lat: 37.1513, lon: 127.0722, radius: 500 },{ name: "ìš©ì¸ì„¼í„°", lat: 37.2411, lon: 127.1776 },{ name: "ì˜ì •ë¶€ì„¼í„°", lat: 37.7379, lon: 127.0471 },{ name: "ì´ì²œì„¼í„°", lat: 37.2773, lon: 127.4449 },{ name: "ì¼ì‚°ì„¼í„°", lat: 37.6831, lon: 126.7758 },{ name: "íŒŒì£¼ì„¼í„°", lat: 37.7601, lon: 126.7797 },{ name: "í‰íƒì„¼í„°", lat: 36.9912, lon: 127.1121 },{ name: "í¬ì²œì„¼í„°", lat: 37.8941, lon: 127.2003 },{ name: "í•˜ë‚¨ì„¼í„°", lat: 37.5367, lon: 127.2081 },{ name: "í™”ì„±ì„¼í„°", lat: 37.1994, lon: 126.8314 }
    ];

    const tableBody = document.getElementById('log-body');
    const addRowButton = document.getElementById('add-row-btn');
    const downloadExcelButton = document.getElementById('download-excel');
    const loader = document.getElementById('loader');
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const closeModal = document.querySelector('.close-modal');
    const saveToGalleryBtn = document.getElementById('save-to-gallery-btn');

    let cropper = null;
    let currentCropInfo = {
        row: null,
        type: null,
        file: null
    };

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ì´ì „ê³¼ ë™ì¼) ---
    tableBody.addEventListener('click', handleTableClick);
    tableBody.addEventListener('change', handleFileChange);
    tableBody.addEventListener('input', handleCellInput);
    addRowButton.addEventListener('click', () => { addNewRow(); updateRowNumbers(); });
    closeModal.onclick = () => { modal.style.display = 'none'; };
    modal.addEventListener('click', (event) => { if (event.target === modal) { modal.style.display = 'none'; } });
    saveToGalleryBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = modalImage.src;
        link.download = `ìš´í–‰ì¼ì§€ì‚¬ì§„_${new Date().getTime()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    downloadExcelButton.addEventListener('click', downloadExcel);

    // --- í¬ë¡­ ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ì „ê³¼ ë™ì¼) ---
    document.getElementById('crop-btn').addEventListener('click', () => {
        if (cropper) {
            const croppedCanvas = cropper.getCroppedCanvas({
                maxWidth: 1024,
                imageSmoothingQuality: 'high',
            });
            croppedCanvas.toBlob((blob) => {
                const croppedFile = new File([blob], currentCropInfo.file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                processImage(croppedFile, currentCropInfo.type, currentCropInfo.row);
            }, 'image/jpeg');
            document.getElementById('crop-modal').style.display = 'none';
            cropper.destroy();
            cropper = null;
        }
    });

    // --- ğŸŒŸ [ìˆ˜ì •ë¨] EXIF ë°©í–¥ ì •ë³´ì— ë§ì¶° ì´ë¯¸ì§€ íšŒì „í•˜ëŠ” í•¨ìˆ˜ ---
    function getCorrectlyOrientedImage(file) {
        return new Promise((resolve, reject) => {
            let orientation = 1;
            EXIF.getData(file, function() {
                orientation = EXIF.getTag(this, 'Orientation') || 1;
            });

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;

                    if (orientation > 4 && orientation < 9) {
                        canvas.width = height;
                        canvas.height = width;
                    } else {
                        canvas.width = width;
                        canvas.height = height;
                    }

                    switch (orientation) {
                        case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
                        case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
                        case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
                        case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                        case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
                        case 7: ctx.transform(0, -1, -1, 0, height, width); break;
                        case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
                        default: ctx.transform(1, 0, 0, 1, 0, 0);
                    }
                    
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL());
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // --- ğŸŒŸ [ìˆ˜ì •ë¨] íŒŒì¼ ë³€ê²½ í•¸ë“¤ëŸ¬ ---
    async function handleFileChange(event) {
        const target = event.target;
        if (target.classList.contains('photo-input')) {
            const file = target.files[0];
            if (!file) return;

            currentCropInfo.row = target.closest('.log-row');
            currentCropInfo.type = target.dataset.type;
            currentCropInfo.file = file;

            showLoader(true);
            try {
                // EXIF ë°©í–¥ì´ ë³´ì •ëœ ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜´
                const correctlyOrientedImageSrc = await getCorrectlyOrientedImage(file);
                
                const cropModal = document.getElementById('crop-modal');
                const imageToCrop = document.getElementById('image-to-crop');
                
                imageToCrop.src = correctlyOrientedImageSrc;
                cropModal.style.display = 'block';

                if (cropper) {
                    cropper.destroy();
                }

                // Cropper.js ì˜µì…˜ ìˆ˜ì • (ëª¨ë°”ì¼ ì•ˆì •ì„± í–¥ìƒ)
                cropper = new Cropper(imageToCrop, {
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    responsive: true,
                    restore: false,
                    checkOrientation: false, // ìˆ˜ë™ìœ¼ë¡œ ë°©í–¥ì„ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ìë™ ì²´í¬ ë¹„í™œì„±í™”
                    autoCropArea: 0.8,
                });
            } catch (error) {
                console.error("ì´ë¯¸ì§€ ë°©í–¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                alert("ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                showLoader(false);
            }
        }
    }
    
    // --- ì´í•˜ í•¨ìˆ˜ë“¤ì€ ì´ì „ ì½”ë“œì™€ ê±°ì˜ ë™ì¼ ---

    function handleTableClick(event) {
        const target = event.target;
        const row = target.closest('.log-row');
        if (!row) return;
        if (target.classList.contains('custom-file-upload') && !target.classList.contains('btn-disabled')) {
            target.nextElementSibling.click();
        } else if (target.classList.contains('thumbnail')) {
            modal.style.display = 'block';
            modalImage.src = target.src;
        } else if (target.classList.contains('edit-row-btn')) {
            toggleRowEditMode(row, target);
        } else if (target.classList.contains('delete-row-btn')) {
            deleteRow(row);
        } else if (target.classList.contains('toggle-btn') && row.classList.contains('completed')) {
            row.classList.toggle('expanded');
            target.textContent = row.classList.contains('expanded') ? 'âˆ’' : '+';
            saveTableData();
        }
    }

    function handleCellInput(event) {
        const target = event.target;
        if (target.isContentEditable) {
            const currentRow = target.closest('.log-row');
            if (target.classList.contains('mileage')) {
                updateDistance(currentRow);
            } else {
                saveTableData();
            }
        }
    }

    async function processImage(croppedFile, type, row) {
        showLoader(true, true);
        try {
            const exifData = await getExifData(currentCropInfo.file);
            await updateTableFromExif(exifData, type, row);
            const compressedImageDataUrl = await compressImage(croppedFile);
            const photoCell = row.querySelector(`.photo-cell.${type}-photo-cell`);
            photoCell.innerHTML = '';
            const thumbnail = document.createElement('img');
            thumbnail.src = compressedImageDataUrl;
            thumbnail.className = 'thumbnail';
            photoCell.appendChild(thumbnail);
            photoCell.dataset.filename = currentCropInfo.file.name;
            photoCell.dataset.imageDataUrl = compressedImageDataUrl;
            row.querySelector(`input[data-type="${type}"]`).previousElementSibling.classList.add('btn-disabled');
            const ocrPromise = recognizeMileage(croppedFile);
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('OCR ì‹œê°„ ì´ˆê³¼ (15ì´ˆ)')), 15000));
            const mileage = await Promise.race([ocrPromise, timeoutPromise]);
            const mileageCell = row.querySelector(`.mileage.${type}-mileage`);
            if (mileage) {
                mileageCell.textContent = mileage;
            } else {
                alert('ì£¼í–‰ê±°ë¦¬ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                mileageCell.textContent = '';
            }
            updateDistance(row);
        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert(error.message);
        } finally {
            showLoader(false);
            saveTableData();
        }
    }

    async function updateTableFromExif(exifData, type, row) {
        let dateToUse;
        if (exifData && exifData.dateTime) {
            let formattedString = exifData.dateTime.replace(' ', 'T').replace(/:/g, (m, o) => o < 10 ? '-' : m);
            dateToUse = new Date(formattedString);
        } else {
            dateToUse = new Date();
        }
        if (isNaN(dateToUse.getTime())) { dateToUse = new Date(); }
        const year = dateToUse.getFullYear(), month = dateToUse.getMonth() + 1, day = dateToUse.getDate();
        const displayDate = `${month}/${day}`, fullDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const formattedTime = `${String(dateToUse.getHours()).padStart(2, '0')}:${String(dateToUse.getMinutes()).padStart(2, '0')}`;
        if (type === 'start') {
            const runDateCell = row.querySelector('.run-date');
            runDateCell.textContent = displayDate;
            runDateCell.dataset.fullDate = fullDate;
            row.querySelector('.start-time').textContent = formattedTime;
        } else {
            row.querySelector('.end-time').textContent = formattedTime;
        }
        if (exifData && exifData.gpsLatitude && exifData.gpsLongitude) {
            const address = await getAddressFromCoordinates(exifData.gpsLatitude, exifData.gpsLongitude);
            row.querySelector(`.${type}-location`).textContent = address;
        } else {
            row.querySelector(`.${type}-location`).textContent = 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
        }
    }

    function updateDistance(row) {
        const startMileage = parseFloat(row.querySelector('.start-mileage').textContent.replace(/,/g, ''));
        const endMileage = parseFloat(row.querySelector('.end-mileage').textContent.replace(/,/g, ''));
        const distanceCell = row.querySelector('.distance');
        if (!isNaN(startMileage) && !isNaN(endMileage) && endMileage >= startMileage) {
            distanceCell.textContent = Math.round(endMileage - startMileage).toLocaleString();
            if (row.dataset.completed === 'false') {
                const rowNum = row.querySelector('.row-number span').textContent;
                if (confirm(`No.${rowNum} ìš´í–‰ì„ ì™„ë£Œí•˜ê³  ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    row.dataset.completed = 'true';
                    row.classList.add('completed');
                    row.querySelector('.toggle-btn').style.display = 'inline-block';
                    if (row === tableBody.lastElementChild) {
                        addNewRow();
                        updateRowNumbers();
                    }
                    saveTableData();
                }
            }
        } else {
            distanceCell.textContent = '';
        }
    }

    function addNewRow(rowData = {}) {
        const newRow = document.createElement('tr');
        newRow.className = 'log-row';
        if (rowData.completed === 'true') { newRow.classList.add('completed'); }
        if (rowData.expanded === true) { newRow.classList.add('expanded'); }
        newRow.dataset.completed = rowData.completed || 'false';
        const startBtnClass = rowData.startPhotoFile ? 'custom-file-upload btn-disabled' : 'custom-file-upload';
        const endBtnClass = rowData.endPhotoFile ? 'custom-file-upload btn-disabled' : 'custom-file-upload';
        const toggleBtnDisplay = rowData.completed === 'true' ? 'inline-block' : 'none';
        const toggleBtnText = rowData.expanded ? 'âˆ’' : '+';
        const startThumbHTML = rowData.startImageDataUrl ? `<img src="${rowData.startImageDataUrl}" class="thumbnail">` : '';
        const endThumbHTML = rowData.endImageDataUrl ? `<img src="${rowData.endImageDataUrl}" class="thumbnail">` : '';
        newRow.innerHTML = `
            <td class="row-number" data-label="No."><span></span><button class="toggle-btn" style="display: ${toggleBtnDisplay};">${toggleBtnText}</button></td>
            <td data-label="ì¶œë°œì´¬ì˜"><label class="${startBtnClass}">ğŸ“¸ ì¶œë°œ</label><input class="photo-input" data-type="start" type="file" accept="image/*" capture="environment"></td>
            <td data-label="ë„ì°©ì´¬ì˜"><label class="${endBtnClass}">ğŸ“¸ ë„ì°©</label><input class="photo-input" data-type="end" type="file" accept="image/*" capture="environment"></td>
            <td class="run-date editable-cell" data-label="ìš´í–‰ ì¼ì" data-full-date="${rowData.fullDate || ''}">${rowData.displayDate || ''}</td>
            <td class="start-location editable-cell" data-label="ì¶œë°œì§€">${rowData.startLocation || ''}</td>
            <td class="end-location editable-cell" data-label="ë„ì°©ì§€">${rowData.endLocation || ''}</td>
            <td class="start-time editable-cell" data-label="ì¶œë°œì‹œê°„(H)">${rowData.startTime || ''}</td>
            <td class="end-time editable-cell" data-label="ë„ì°©ì‹œê°„(H)">${rowData.endTime || ''}</td>
            <td class="mileage start-mileage" contenteditable="true" data-label="ì¶œë°œ(km)">${rowData.startMileage || ''}</td>
            <td class="mileage end-mileage" contenteditable="true" data-label="ë„ì°©(km)">${rowData.endMileage || ''}</td>
            <td class="distance" data-label="ì£¼í–‰ê±°ë¦¬(km)">${rowData.distance || ''}</td>
            <td contenteditable="true" data-label="ë¹„ê³ ">${rowData.remarks || ''}</td>
            <td class="photo-cell start-photo-cell" data-label="ì¶œë°œì‚¬ì§„" data-filename="${rowData.startPhotoFile || ''}" data-image-data-url="${rowData.startImageDataUrl || ''}">${startThumbHTML}</td>
            <td class="photo-cell end-photo-cell" data-label="ë„ì°©ì‚¬ì§„" data-filename="${rowData.endPhotoFile || ''}" data-image-data-url="${rowData.endImageDataUrl || ''}">${endThumbHTML}</td>
            <td data-label="ê´€ë¦¬"><button class="action-btn edit-row-btn">ìˆ˜ì •</button><button class="action-btn delete-row-btn">ì‚­ì œ</button></td>
        `;
        tableBody.appendChild(newRow);
    }

    function deleteRow(row) {
        if (confirm('ì´ í–‰ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const isLastRow = tableBody.children.length <= 1;
            row.remove();
            if (isLastRow) { addNewRow(); }
            updateRowNumbers();
            saveTableData();
        }
    }

    function updateRowNumbers() {
        const rows = tableBody.querySelectorAll('.log-row');
        rows.forEach((row, index) => {
            row.querySelector('.row-number span').textContent = index + 1;
        });
    }

    function toggleRowEditMode(row, button) {
        const isEditing = !row.classList.contains('is-editing');
        row.classList.toggle('is-editing', isEditing);
        button.textContent = isEditing ? 'ì™„ë£Œ' : 'ìˆ˜ì •';
        button.classList.toggle('editing', isEditing);
        const cellsToEdit = row.querySelectorAll('.editable-cell');
        cellsToEdit.forEach(cell => {
            cell.contentEditable = isEditing;
        });
        if (!isEditing) {
            const runDateCell = row.querySelector('.run-date');
            const dateParts = runDateCell.textContent.split('/');
            if (dateParts.length === 2) {
                const yearGuess = new Date().getFullYear();
                const month = String(dateParts[0]).padStart(2, '0');
                const day = String(dateParts[1]).padStart(2, '0');
                runDateCell.dataset.fullDate = `${yearGuess}-${month}-${day}`;
            }
            saveTableData();
        }
    }

    function saveTableData() {
        try {
            const rows = document.querySelectorAll('#log-body .log-row');
            const dataToSave = Array.from(rows).map(row => {
                const runDateCell = row.querySelector('.run-date');
                const startPhotoCell = row.querySelector('.start-photo-cell');
                const endPhotoCell = row.querySelector('.end-photo-cell');
                return {
                    completed: row.dataset.completed,
                    expanded: row.classList.contains('expanded'),
                    displayDate: runDateCell.textContent,
                    fullDate: runDateCell.dataset.fullDate,
                    startLocation: row.querySelector('.start-location').textContent,
                    endLocation: row.querySelector('.end-location').textContent,
                    startTime: row.querySelector('.start-time').textContent,
                    endTime: row.querySelector('.end-time').textContent,
                    startMileage: row.querySelector('.start-mileage').textContent,
                    endMileage: row.querySelector('.end-mileage').textContent,
                    distance: row.querySelector('.distance').textContent,
                    remarks: row.querySelector('[data-label="ë¹„ê³ "]').textContent,
                    startPhotoFile: startPhotoCell.dataset.filename,
                    endPhotoFile: endPhotoCell.dataset.filename,
                    startImageDataUrl: startPhotoCell.dataset.imageDataUrl,
                    endImageDataUrl: endPhotoCell.dataset.imageDataUrl
                };
            });
            localStorage.setItem('drivingLogData', JSON.stringify(dataToSave));
        } catch (e) {
            console.error("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
            alert("ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
    }

    function loadTableData() {
        const savedData = localStorage.getItem('drivingLogData');
        if (savedData) {
            try {
                const dataArray = JSON.parse(savedData);
                if (dataArray && dataArray.length > 0) {
                    tableBody.innerHTML = '';
                    dataArray.forEach(rowData => { addNewRow(rowData); });
                    updateRowNumbers();
                    return;
                }
            } catch (e) {
                console.error("ì €ì¥ëœ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
                localStorage.removeItem('drivingLogData');
            }
        }
        addNewRow();
        updateRowNumbers();
    }

    function downloadExcel() {
        const table = document.getElementById('log-table').cloneNode(true);
        const headerCells = Array.from(table.tHead.rows[0].cells);
        const manageHeaderIndex = headerCells.findIndex(th => th.textContent === 'ê´€ë¦¬');
        if (manageHeaderIndex > -1) {
            table.tHead.rows[0].deleteCell(manageHeaderIndex);
            Array.from(table.tBodies[0].rows).forEach(row => { row.deleteCell(manageHeaderIndex); });
        }
        table.querySelectorAll('.log-row').forEach(row => {
            row.querySelector('.row-number').innerHTML = row.querySelector('.row-number span').textContent;
            const runDateCell = row.querySelector('.run-date');
            if (runDateCell) runDateCell.textContent = runDateCell.dataset.fullDate || runDateCell.textContent;
            const startCell = row.querySelector('.start-photo-cell');
            const endCell = row.querySelector('.end-photo-cell');
            if (startCell) startCell.innerHTML = startCell.dataset.filename || '';
            if (endCell) endCell.innerHTML = endCell.dataset.filename || '';
        });
        const wb = XLSX.utils.table_to_book(table, { sheet: "ìš´í–‰ì¼ì§€" });
        XLSX.writeFile(wb, 'ìš´í–‰ì¼ì§€.xlsx');
    }

    function getExifData(file) {
        return new Promise((resolve) => {
            let resolved = false;
            const timeoutId = setTimeout(() => { if (!resolved) { console.warn("EXIF ì½ê¸° ì‹œê°„ ì´ˆê³¼"); resolved = true; resolve(null); } }, 2000);
            try {
                EXIF.getData(file, function() {
                    if (resolved) return;
                    clearTimeout(timeoutId);
                    const dt = EXIF.getTag(this, "DateTimeOriginal"), gLatR = EXIF.getTag(this, "GPSLatitudeRef"), gLat = EXIF.getTag(this, "GPSLatitude"), gLonR = EXIF.getTag(this, "GPSLongitudeRef"), gLon = EXIF.getTag(this, "GPSLongitude");
                    let lat = null, lon = null;
                    if (gLat && gLon) { lat = convertDMSToDD(gLat, gLatR); lon = convertDMSToDD(gLon, gLonR); }
                    resolved = true;
                    resolve({ dateTime: dt || null, gpsLatitude: lat, gpsLongitude: lon });
                });
            } catch (error) { if (resolved) return; clearTimeout(timeoutId); console.error("EXIF ì²˜ë¦¬ ì—ëŸ¬:", error); resolve(null); }
        });
    }

    function compressImage(file, maxWidth = 1024, quality = 0.8) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.onerror = reject;
                img.src = (typeof file === 'string') ? file : e.target.result;
            };
            reader.onerror = reject;
            if (typeof file === 'string') {
                reader.onload({ target: { result: file }});
            } else {
                reader.readAsDataURL(file);
            }
        });
    }

    async function recognizeMileage(imageSource) {
        const worker = await Tesseract.createWorker('kor+eng');
        try {
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789',
            });
            const { data: { text } } = await worker.recognize(imageSource);
            const mileage = text.replace(/\D/g, ''); 
            if (mileage && mileage.length >= 4) { // ë” ì§§ì€ ìˆ«ìë„ ì¸ì‹í•˜ë„ë¡ 5->4ë¡œ ë³€ê²½
                return mileage;
            }
            console.log("OCR ê²°ê³¼:", text);
            return null;
        } catch (error) { 
            console.error("OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error); 
            return null; 
        } finally { 
            await worker.terminate(); 
        }
    }

    function convertDMSToDD(dms, ref) {
        if (!dms || dms.length < 3) return 0;
        const dd = dms[0] + dms[1] / 60 + dms[2] / 3600;
        return (ref === "S" || ref === "W") ? -dd : dd;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    async function getAddressFromCoordinates(lat, lon) {
        for (const center of serviceCenters) {
            const searchRadius = center.radius || 500;
            const distance = calculateDistance(lat, lon, center.lat, center.lon);
            if (distance <= searchRadius) {
                return center.name;
            }
        }
        const GOOGLE_API_KEY = 'AIzaSyDmq6ArU2ueu7jrOjlBEFJBlF3C_CfrzWI';
        if (GOOGLE_API_KEY.includes('ë°œê¸‰ë°›ì€')) return "API í‚¤ í•„ìš”";
        const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${GOOGLE_API_KEY}&language=ko`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.status === 'OK' && data.results.length > 0) {
                const comps = data.results[0].address_components;
                let city = '', gu = '', dong = '';
                for (const c of comps) {
                    if (c.types.includes("locality")) city = c.long_name;
                    if (c.types.includes("sublocality_level_1")) gu = c.long_name;
                    if (c.types.includes("sublocality_level_2")) dong = c.long_name;
                }
                return `${gu || city} ${dong}`.trim() || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
            }
            return "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
        } catch (error) { return "ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨"; }
    }

    function showLoader(show, showProgress = false) {
        const loader = document.getElementById('loader');
        const progressBarContainer = loader.querySelector('.progress-bar-container');
        const progressBar = loader.querySelector('.progress-bar');
        const loaderText = loader.querySelector('#loader-text');
        if (show) {
            loader.style.display = 'flex';
            if (showProgress) {
                loaderText.textContent = 'ê³„ê¸°íŒ ì£¼í–‰ê±°ë¦¬ë¥¼ í™•ì¸í•©ë‹ˆë‹¤... (15ì´ˆ)';
                progressBarContainer.style.display = 'block';
                progressBar.classList.remove('animated');
                void progressBar.offsetWidth;
                progressBar.classList.add('animated');
            } else {
                loaderText.textContent = 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
                progressBarContainer.style.display = 'none';
            }
        } else {
            loader.style.display = 'none';
        }
    }

    loadTableData();
});
</script>
